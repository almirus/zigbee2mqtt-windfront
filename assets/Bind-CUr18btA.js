import{r as d,j as n,b as O,av as P,c as N,aw as y,C as E,F as v,o as T,ax as A,a as B,k as R}from"./index-Cg_dwqpD.js";import{D as F}from"./DevicePicker-BKPECTmF.js";import{E as S}from"./EndpointPicker-Dnt0o2EO.js";import"./envs-CSqIi4cL.js";import"./SelectField-dfeWrxvV.js";const U=d.memo(s=>{const{clusters:o,onChange:c,label:l,value:i,disabled:e}=s,g=d.useCallback(u=>{const{checked:x,name:_}=u.target;let h=[...i];x?h.push(_):h=h.filter(w=>w!==_),c(h)},[c,i]),r=d.useMemo(()=>Array.from(o).sort((u,x)=>u.toString().localeCompare(x.toString())).map(u=>n.jsxs("label",{className:"label",title:u,children:[n.jsx("input",{className:"checkbox checkbox-sm",type:"checkbox",checked:i.includes(u),name:u,value:u,onChange:g,disabled:e}),u]},u)),[o,g,i,e]);return n.jsxs("fieldset",{className:"fieldset",children:[l&&n.jsx("legend",{className:"fieldset-legend",children:l}),n.jsx("div",{className:"flex flex-row flex-wrap gap-2",children:r})]})}),V=(s,o,c)=>{const{target:l}=s;return l.type==="group"?c.find(i=>i.id===l.id):o.find(i=>i.ieee_address===l.ieee_address)},z=d.memo(({sourceIdx:s,devices:o,groups:c,device:l,rule:i})=>{const[e,g]=d.useState(i),{t:r}=O(["common","zigbee"]);d.useEffect(()=>{g(i)},[i]);const u=d.useCallback(t=>{g(a=>({...a,source:{...a.source,endpoint:t}}))},[]),x=d.useCallback(t=>{if(!t)return;const a=P(t)?{type:"endpoint",ieee_address:t.ieee_address,endpoint:""}:{type:"group",id:t.id};g(m=>({...m,target:a,clusters:[]}))},[]),_=d.useCallback(t=>{e.target.type==="endpoint"&&g(a=>({...a,target:{...a.target,endpoint:t},clusters:[]}))},[e.target.type]),h=d.useCallback(t=>{g(a=>({...a,clusters:t}))},[]),w=d.useCallback(async t=>{let a="",m;const{target:p}=e;if(p.type==="group"){const b=c.find(C=>C.id===p.id);if(b)a=b.id;else{console.error("Target group does not exist:",p.id);return}}else if(p.type==="endpoint"){const b=o.find(C=>C.ieee_address===p.ieee_address);if(b)a=b.ieee_address,b.type!=="Coordinator"&&(m=p.endpoint);else{console.error("Target device does not exist:",p.ieee_address);return}}const f={from:l.ieee_address,from_endpoint:e.source.endpoint,to:a,to_endpoint:m,clusters:e.clusters};t==="Bind"?await N(s,"bridge/request/device/bind",f):await N(s,"bridge/request/device/unbind",f)},[s,l,e,o,c]),D=d.useMemo(()=>y(l),[l]),j=V(e,o,c),M=d.useMemo(()=>y(j),[j]),q=d.useMemo(()=>{const t=new Set(e.clusters),a=l.endpoints[e.source.endpoint],m=e.target.type==="endpoint"&&e.target.endpoint!=null?j?.endpoints[e.target.endpoint]:void 0,p=e.target.type==="group"||j?.type==="Coordinator";if(a&&(m||p))for(const f of[...a.clusters.input,...a.clusters.output])if(p)t.add(f);else{const b=a.clusters.input.includes(f)&&m?.clusters.output.includes(f),C=a.clusters.output.includes(f)&&m?.clusters.input.includes(f);(b||C||p)&&t.add(f)}return t},[l.endpoints,e,j]),k=d.useMemo(()=>{let t=!1;return e.target.type==="endpoint"?t=!!(e.source.endpoint&&e.target.ieee_address&&e.target.endpoint&&e.clusters.length>0):e.target.type==="group"&&(t=!!(e.source.endpoint&&e.target.id&&e.clusters.length>0)),t},[e]);return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[n.jsx(S,{label:r(t=>t.source_endpoint),disabled:!e.isNew,values:D,value:e.source.endpoint,onChange:u,required:!0}),n.jsx(F,{label:r(t=>t.destination),disabled:!e.isNew,value:"ieee_address"in e.target?e.target.ieee_address:e.target.id,devices:o,groups:c,onChange:x,required:!0}),e.target.type==="endpoint"?n.jsx(S,{label:r(t=>t.destination_endpoint),disabled:!e.isNew,values:M,value:e.target.endpoint,onChange:_}):null,n.jsx("div",{className:"grow w-128",children:n.jsx(U,{label:r(t=>t.clusters),clusters:q,value:e.clusters,onChange:h})}),n.jsxs("fieldset",{className:"fieldset",children:[n.jsx("legend",{className:"fieldset-legend",children:r(t=>t.actions)}),n.jsxs("div",{className:"join join-horizontal",children:[n.jsxs(E,{item:"Bind",disabled:!k,title:r(t=>t.bind),className:"btn btn-primary btn-outline join-item",onClick:w,children:[n.jsx(v,{icon:T}),r(t=>t.bind)," "]}),n.jsxs(E,{item:"Unbind",disabled:e.isNew||!k,title:r(t=>t.unbind),className:"btn btn-error btn-outline join-item",onClick:w,children:[n.jsx(v,{icon:A})," ",r(t=>t.unbind)]})]})]})]}),n.jsx("div",{className:"divider my-1"})]})}),$=s=>({isNew:!0,target:{type:"endpoint",ieee_address:"",endpoint:""},source:{ieee_address:s,endpoint:""},clusters:[]}),G=s=>{const o={};for(const c in s.endpoints){const l=s.endpoints[c];for(const i of l.bindings){let e="ieee_address"in i.target?`${i.target.ieee_address}-${i.target.endpoint}`:i.target.id;e=`${e}-${c}`,o[e]?o[e].clusters.push(i.cluster):o[e]={source:{ieee_address:s.ieee_address,endpoint:c},target:{...i.target},clusters:[i.cluster]}}}return Object.values(o)},H=s=>`${s.isNew}-${s.source.endpoint}-${s.source.ieee_address}-${"ieee_address"in s.target?s.target.ieee_address:s.target.id}-${s.clusters.join("-")}`;function W({sourceIdx:s,device:o}){const c=B(R(r=>r.devices[s])),l=B(R(r=>r.groups[s])),[i,e]=d.useState($(o.ieee_address)),g=d.useMemo(()=>G(o),[o]);return d.useEffect(()=>{e($(o.ieee_address))},[o.ieee_address]),n.jsx("div",{className:"flex flex-col w-full",children:[...g,i].map(r=>n.jsx(z,{rule:r,sourceIdx:s,groups:l,device:o,devices:c},H(r)))})}export{W as default};
